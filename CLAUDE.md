# APISCAN - API Endpoint Scanner

## Project Overview
**apiscan** is a CLI application that extracts API endpoints from various implementation types and generates OpenAPI documentation.

## Core Requirements

### Critical Design Constraint
**NO COMPILATION/BUILD REQUIRED**: The tool MUST analyze source code as-is by reading files directly, without requiring compilation or build. Many enterprise projects cannot be compiled due to dependencies, configurations, or access restrictions.

### Goals
- Generate OpenAPI file in JSON or YAML format (✅ **ALWAYS GENERATED BY DEFAULT**)
- Output professional summary report
- Enterprise grade quality
- Extensible architecture (future: Quarkus, Struts, .NET Core)
- AST-based implementation for accurate extraction

### MVP Scope
- Java-based API implementations
- Spring MVC/Boot support
- Test Projects: `C:\Users\Rudi Kristanto\prj\spring-petclinic-rest`, `C:\Users\Rudi Kristanto\prj\shopizer`

## Key Features & Solutions

### 1. Interface-Based Endpoint Detection
Three approaches for comprehensive API discovery:
1. **Direct Annotation Scanning**: Spring mapping annotations (`@GetMapping`, `@PostMapping`, etc.)
2. **Interface Implementation Analysis**: Matches controllers implementing annotated interfaces
3. **@Override Method Inference**: Infers endpoints from method names when interfaces unavailable:
   - Method name analysis: `listOwners`→GET, `addOwner`→POST, `updateOwner`→PUT, `deleteOwner`→DELETE
   - RESTful path construction: `getOwner(Integer ownerId)`→`/owners/{ownerId}`
   - Nested resource support: `addPetToOwner`→`/owners/{ownerId}/pets`

**Results**: spring-petclinic-rest: 1→35 endpoints (35x improvement)

### 2. Multi-Module & Microservices Project Support

#### Multi-Module Maven Projects
- Detects multi-module Maven projects automatically via parent pom.xml
- Scans all modules when parent directory provided
- Cross-module API discovery in single operation
- Usage: `java -jar apiscan-cli.jar "C:\path\to\project"` (no need to specify module)

#### Independent Microservices Architecture
- **NEW**: Supports independent microservices without parent build files
- Automatically detects multiple Spring Boot services in subdirectories
- Each microservice has its own pom.xml/build.gradle
- Examples: Banking microservices, distributed systems

#### Microservices Output Options
- **Combined Mode (Default)**: Single OpenAPI file with all microservices
- **Separate Mode**: Individual OpenAPI file per microservice
- Usage: `--microservices-output combined|separate`

```bash
# Combined output (default)
java -jar apiscan-cli.jar "C:\path\to\microservices"

# Separate files per microservice
java -jar apiscan-cli.jar "C:\path\to\microservices" --microservices-output separate

# Custom output directory for separate files
java -jar apiscan-cli.jar "C:\path\to\microservices" --microservices-output separate -o "./openapi-specs/"
```

#### DTO Schema Resolution Strategy
Enhanced search supporting all scenarios:
```java
// 1. Search current directory for sub-modules (parent directory with modules)
Path currentDir = Paths.get(projectPath);
List<Path> subModuleMatches = findAllMatchesInMultiModuleProject(currentDir, className);

// 2. Search parent directory for sibling modules (single module with siblings)
Path parentDir = currentDir.getParent();
List<Path> siblingModuleMatches = findAllMatchesInMultiModuleProject(parentDir, className);

// 3. Independent microservices - search across all services
List<Path> microserviceMatches = findAllMatchesInIndependentMicroservices(projectPath, className);
```

#### Package Prioritization
Intelligent DTO vs Entity selection:
- **High Priority (DTO layers)**: `sm-shop-model`, `shop.model`, `api.model`, `dto`, `generated`
- **Low Priority (JPA entities)**: `sm-core-model`, `core.model`, `entity`, `domain`, `persistence`
- **Microservices**: Recognizes `service`, `core`, `notification.domain`, `account.domain` patterns

**Impact**: Shopizer `CustomerOption`: 9 properties (JPA)→1 property (DTO)

### 3. OpenAPI Generation & Compliance

#### Default Behavior
- **Automatic Generation**: Always creates `{project-name}-openapi.{format}` file
- **Formats**: YAML (default), JSON (`-f json`)
- **Custom Output**: `-o custom-name.yaml`

#### Microservices Tag Normalization
- **Smart Controller Grouping**: Groups related controllers/services under unified tags
- **Tag Consolidation**: `TransactionController` + `TransactionService` → "Transaction" tag
- **Prevents Empty Sections**: Eliminates empty collapsible sections in OpenAPI viewers
- **Pattern Recognition**: Strips `Controller`, `Service`, `RestController`, `Impl`, `API` suffixes

Examples:
```java
// Before (creates empty sections):
- TransactionController → "Transaction" tag
- TransactionService   → "TransactionService" tag (empty if no endpoints)

// After (consolidated):  
- TransactionController → "Transaction" tag
- TransactionService   → "Transaction" tag (merged under same section)
```

#### Critical Fixes for Validation
1. **Path Parameter Matching**: Exact name matching between `{param}` and definitions
2. **Schema Name Sanitization**: `?`→`UnknownType`, `byte[]`→`ByteArray`, strips generics
3. **Unique OperationId**: Multi-strategy uniqueness with fallbacks
4. **Request Body Validation**: Only POST/PUT/PATCH support request bodies
5. **Query Parameter Preservation**: Fixed filtering logic to retain legitimate query params
6. **File Upload Support**: Proper `multipart/form-data` with encoding info
7. **100 Endpoint Debug Limit**: REMOVED - all endpoints now processed
8. **Constant Resolution**: Resolves static final field references in annotations (e.g., `Constants.ACCEPT`→`"Accept"`)

#### Response Code Generation
Complete HTTP status codes: 200, 201, 304, 400, 404, 500 with appropriate schemas

### 4. DTO Schema Resolution

#### Core Functionality
- AST-based parsing for field extraction
- OpenAPI 3.0.3 compliant `$ref` references
- Handles generated code, dual DTO patterns, missing DTOs gracefully

#### Advanced Features
1. **Field Filtering**:
   - Excludes static fields, `serialVersionUID`, `DEFAULT_*` patterns
   - Respects `@ApiIgnore`, `@JsonIgnore`, `@Hidden`
   - Only includes public fields or fields with getters

2. **Circular Reference Prevention**:
   - Uses `$ref` links instead of inline expansion
   - Depth-limited resolution (default: 7 levels for enterprise entities)
   - Tracks resolved schemas to prevent infinite loops

3. **Request Body Detection**:
   - Prioritizes explicit `@RequestBody` annotations
   - Filters framework types (`Principal`, `HttpServletRequest`, etc.)
   - Smart DTO detection for POST/PUT/PATCH methods

### 5. Professional Output

#### CLI Formatting
- ASCII-safe characters for Windows compatibility
- Fixed-width columns for alignment
- Consistent 8-character method icon width
- Professional headers and section separators
- Reduced debug noise (use error level for important multi-module messages)

#### Test Results
- **Shopizer**: 324 endpoints, 145 schemas, zero validation errors
- **PiggyMetrics**: Correct `Recipient` request body (was showing `Principal`)
- **File Uploads**: Proper Swagger UI rendering with upload controls

## Java Requirements
- **Minimum**: Java 17
- **APIs Used**: Files.readString(), Files.writeString(), Set.of(), Optional.isEmpty(), String.repeat()

## Development Guidelines
1. **Never compile/build** analyzed projects - read source directly
2. **Use AST parsing** for accurate extraction
3. **Maintain extensibility** for future frameworks
4. **Test with real projects**: spring-petclinic-rest, shopizer, banking microservices
5. **Prioritize DTOs over entities** in multi-module projects
6. **Handle missing dependencies gracefully**
7. **Generate valid OpenAPI 3.0.3** specifications
8. **Support both single/multi-module and microservices architectures**

## Critical Implementation Notes

### Framework Detection & Scanning
- `SpringFrameworkDetector.isMultipleMicroservices()` detects independent microservices (≥2 services without parent build file)
- `SpringFrameworkScanner.isIndependentMicroservices()` determines scanning strategy
- `SpringFrameworkScanner.findJavaFilesInIndependentMicroservices()` scans all microservices
- Multi-module vs microservices: parent build file presence is the key differentiator

### Multi-Architecture Support
- **Single Project**: Direct src/main/java scanning
- **Multi-Module**: Parent pom.xml + child modules with their own pom.xml files
- **Independent Microservices**: Multiple service directories with build files, no parent build file

### Core Components
- SpringFrameworkScanner handles multi-module discovery via `isMultiModuleProject()`, `findJavaFilesInMultiModuleProject()`
- SpringFrameworkScanner collects constants in first pass via `collectConstants()`, resolves via `resolveAnnotationValue()`
- DtoSchemaResolver uses `getAllResolvedSchemas()` for controlled recursive resolution
- SwaggerCoreOpenApiGenerator ensures compliance with `sanitizeSchemaName()`, `ensureUniqueOperationId()`, `buildMultipartRequestBody()`
- **SwaggerCoreOpenApiGenerator.normalizeTagName()** consolidates controller/service tags to prevent empty OpenAPI sections
- Multi-module prioritization messages use `logger.error()` for visibility
- File upload parameters need `in="formData"` classification and encoding info for proper UI rendering

### CLI Microservices Support
- `ApiScanCLI.handleMicroservices()` orchestrates individual service scanning
- `MicroservicesOutputMode.combined` merges all service results into single OpenAPI file
- `MicroservicesOutputMode.separate` generates individual OpenAPI files per microservice
- Microservices excluded from scanning: `.git`, `docs`, `target`, `build`, `postman_collection`

### User Experience Enhancements
- **Progress Indicators**: ASCII spinner animations show during long operations (scanning, OpenAPI generation)
- **Clean Output**: Removed prefix tags ([INFO], [SUCCESS], etc.) for more natural console output
- **Windows Compatibility**: ASCII-safe output (no Unicode symbols) for proper display in CMD/PowerShell
- **Logging Separation**: Debug info (MULTI-MATCH, PRIORITIZATION) goes to `apiscan-debug.log`, clean output to console
- **Test Noise Suppression**: `logback-test.xml` silences expected JavaParser errors in negative test cases